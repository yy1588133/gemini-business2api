import{g as B,d as de,h as m,I as ce,i as M,o as ie,j as ue,c as n,a as s,y as W,b as y,t as r,n as h,w as U,p as z,F as w,r as k,k as O,v as me,e as a}from"./index-Duw_mHSu.js";import{_ as xe}from"./SelectMenu.vue_vue_type_script_setup_true_lang-C6lwE8ta.js";import{_ as pe}from"./ConfirmDialog.vue_vue_type_script_setup_true_lang-B0kbsWTx.js";const F={list:G=>B.get("/admin/log",{params:G}),clear:()=>B.delete("/admin/log?confirm=yes")},ve={class:"rounded-3xl border border-border bg-card p-6"},fe={class:"flex flex-wrap items-center justify-between gap-3"},be={class:"text-xs text-muted-foreground"},ge={class:"mt-4 grid grid-cols-2 gap-3 md:grid-cols-3 xl:grid-cols-6"},ye={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},he={class:"mt-1 text-lg font-semibold text-foreground"},_e={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},we={class:"mt-1 text-lg font-semibold text-foreground"},Ce={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},Re={class:"mt-1 text-lg font-semibold text-foreground"},Ie={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},ke={class:"mt-1 text-lg font-semibold text-foreground"},Oe={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},Ne={class:"rounded-2xl border border-border bg-card px-4 py-3 text-center"},Le={class:"mt-1 text-lg font-semibold text-foreground"},Se={class:"mt-4 flex flex-wrap items-center gap-2 sm:flex-nowrap"},$e={class:"w-44 shrink-0"},Ae={key:1,class:"mt-4 rounded-2xl bg-destructive/10 px-4 py-3 text-sm text-destructive"},Te={class:"whitespace-pre-wrap font-mono leading-relaxed"},Ee={key:0,class:"text-xs text-muted-foreground"},Me={class:"flex flex-wrap items-center gap-2 rounded-xl border border-border bg-card px-3 py-2 text-xs"},Ue={class:"flex flex-wrap items-center gap-2"},Fe={class:"text-muted-foreground"},Ge={class:"w-full text-foreground md:w-auto md:flex-1"},Ve=["onClick"],De={class:"text-muted-foreground"},He={key:1,class:"text-muted-foreground"},je={class:"text-muted-foreground"},qe={class:"space-y-2 px-4 py-3"},Be={class:"flex flex-wrap items-center gap-2"},We={class:"text-muted-foreground"},ze={class:"w-full text-foreground md:w-auto md:flex-1"},Ze=de({__name:"Logs",setup(G){const A=m([]),p=m(null),N=m(""),v=m(""),C=m("success"),L=m(!1),R=m(!0),I=m({}),f=m(!1),b=m(null),g=m(null);let _;const i=ce({level:"",search:"",limit:1500}),J=[{label:"全部",value:""},{label:"INFO",value:"INFO"},{label:"WARNING",value:"WARNING"},{label:"ERROR",value:"ERROR"}],Y={SYSTEM:"#9e9e9e",CONFIG:"#607d8b",LOG:"#9e9e9e",AUTH:"#4caf50",SESSION:"#00bcd4",FILE:"#ff9800",CHAT:"#2196f3",API:"#8bc34a",CACHE:"#9c27b0",ACCOUNT:"#f44336",MULTI:"#673ab7"},P={account_1:"#9c27b0",account_2:"#e91e63",account_3:"#00bcd4",account_4:"#4caf50",account_5:"#ff9800"},Z=M(()=>C.value==="error"?"text-destructive":"text-muted-foreground"),V=e=>Y[e]||"#757575",T=e=>P[e]||"#757575",D=e=>{const t="rounded px-2 py-0.5 text-[10px] font-semibold";return e==="INFO"?`${t} bg-blue-100 text-blue-700`:e==="WARNING"?`${t} bg-amber-100 text-amber-700`:e==="ERROR"||e==="CRITICAL"?`${t} bg-rose-100 text-rose-700`:`${t} bg-violet-100 text-violet-700`},K=e=>{const t="rounded-md px-2 py-0.5 text-[11px] font-semibold";return e==="success"?`${t} bg-emerald-100 text-emerald-700`:e==="error"?`${t} bg-rose-100 text-rose-700`:e==="timeout"?`${t} bg-amber-100 text-amber-700`:`${t} bg-amber-100 text-amber-700`},Q=e=>e==="success"?"成功":e==="error"?"失败":e==="timeout"?"超时":"进行中",x=e=>{let t=e;const o=[];let l="";const d=/^\[([A-Za-z0-9_]+)\]/;for(;;){const c=t.match(d);if(!c)break;const u=c[1];if(t=t.slice(c[0].length).trim(),!u.startsWith("req_")){if(u.startsWith("account_")){l=u;continue}o.push(u)}}return{tags:o,accountId:l,text:t}},X=e=>{if(/^\d{4}-\d{2}-\d{2}T/.test(e))return new Date(e);if(/^\d{4}-\d{2}-\d{2}/.test(e))return new Date(e.replace(" ","T"));if(/^\d{2}:\d{2}:\d{2}$/.test(e)){const t=new Date,[o,l,d]=e.split(":").map(Number),c=new Date(t);return c.setHours(o,l,d,0),c}return null},ee=e=>{const t=e[e.length-1],o=t.message;if(o.includes("响应完成")||o.includes("非流式响应完成"))return"success";if(t.level==="ERROR"||o.includes("失败"))return"error";const l=X(t.time);return l&&(Date.now()-l.getTime())/1e3/60>5?"timeout":"in_progress"},S=M(()=>{const e=new Map,t=[],o=[];A.value.forEach(d=>{const c=d.message.match(/\[req_([a-z0-9]+)\]/i);if(c){const u=c[1];e.has(u)||(e.set(u,[]),t.push(u)),e.get(u)?.push(d)}else o.push(d)});const l=t.map(d=>{const c=e.get(d)||[],u=c[0],j=u?.message.match(/\[(account_[^\]]+)\]/i),q=u?.message.match(/收到请求: ([^ |]+)/)||u?.message.match(/Received request: ([^ |]+)/);return{id:d,logs:c,status:ee(c),accountId:j?j[1]:"",model:q?q[1]:""}});return{ungrouped:o,groups:l}}),te=M(()=>A.value.map(e=>`${e.time} | ${e.level} | ${e.message}`).join(`
`)),E=e=>I.value[e]===!0,se=e=>{I.value[e]=!E(e),localStorage.setItem("log-fold-state",JSON.stringify(I.value))},oe=()=>{(!i.limit||Number.isNaN(i.limit))&&(i.limit=1500),i.limit=Math.min(Math.max(i.limit,10),3e3)},$=async()=>{N.value="",v.value="",oe();try{const e=await F.list({limit:i.limit,level:i.level||void 0,search:i.search||void 0});A.value=e.logs,p.value=e.stats,requestAnimationFrame(()=>{f.value&&b.value&&(b.value.scrollTop=b.value.scrollHeight),!f.value&&g.value&&(g.value.scrollTop=g.value.scrollHeight)})}catch(e){N.value=e.message||"日志加载失败"}},re=async()=>{v.value="",C.value="success";try{const e=await F.list({limit:3e3,level:i.level||void 0,search:i.search||void 0}),t=new Blob([JSON.stringify({exported_at:new Date().toISOString(),logs:e.logs},null,2)],{type:"application/json"}),o=URL.createObjectURL(t),l=document.createElement("a");l.href=o,l.download=`logs_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.json`,l.click(),URL.revokeObjectURL(o),v.value="导出成功"}catch(e){C.value="error",v.value=e.message||"导出失败"}},le=async()=>{L.value=!1;try{await F.clear(),C.value="success",v.value="已清空日志",await $()}catch(e){C.value="error",v.value=e.message||"清空失败"}},H=()=>{_&&(window.clearInterval(_),_=void 0),R.value&&(_=window.setInterval($,3e3))},ne=()=>{R.value=!R.value,H()},ae=()=>{f.value=!f.value,requestAnimationFrame(()=>{f.value&&b.value&&(b.value.scrollTop=b.value.scrollHeight),!f.value&&g.value&&(g.value.scrollTop=g.value.scrollHeight)})};return ie(()=>{const e=localStorage.getItem("log-fold-state");if(e)try{I.value=JSON.parse(e)}catch{I.value={}}$(),H()}),ue(()=>{_&&window.clearInterval(_)}),(e,t)=>(a(),n(w,null,[s("div",ve,[s("div",fe,[t[5]||(t[5]=s("p",{class:"text-base font-semibold text-foreground"},"管理日志",-1)),s("div",be," 自动刷新："+r(R.value?"开启":"关闭"),1)]),s("div",ge,[s("div",ye,[t[6]||(t[6]=s("div",{class:"text-[11px] text-muted-foreground"},"总数",-1)),s("div",he,r(p.value?.memory.total??0),1)]),s("div",_e,[t[7]||(t[7]=s("div",{class:"text-[11px] text-muted-foreground"},"对话",-1)),s("div",we,r(p.value?.chat_count??0),1)]),s("div",Ce,[t[8]||(t[8]=s("div",{class:"text-[11px] text-muted-foreground"},"INFO",-1)),s("div",Re,r(p.value?.memory.by_level.INFO??0),1)]),s("div",Ie,[t[9]||(t[9]=s("div",{class:"text-[11px] text-muted-foreground"},"WARNING",-1)),s("div",ke,r(p.value?.memory.by_level.WARNING??0),1)]),s("div",Oe,[t[10]||(t[10]=s("div",{class:"text-[11px] text-muted-foreground"},"ERROR",-1)),s("div",{class:h(["mt-1 text-lg font-semibold",p.value?.memory.by_level.ERROR?"text-rose-600":"text-foreground"])},r(p.value?.memory.by_level.ERROR??0),3)]),s("div",Ne,[t[11]||(t[11]=s("div",{class:"text-[11px] text-muted-foreground"},"缓存上限",-1)),s("div",Le,r(p.value?.memory.capacity??0),1)])]),s("div",Se,[s("div",$e,[W(xe,{modelValue:i.level,"onUpdate:modelValue":t[0]||(t[0]=o=>i.level=o),options:J},null,8,["modelValue"])]),U(s("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>i.search=o),type:"text",placeholder:"搜索...",class:"min-w-[200px] flex-1 rounded-2xl border border-border bg-background px-3 py-2 text-xs text-foreground sm:min-w-0"},null,512),[[z,i.search,void 0,{trim:!0}]]),U(s("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>i.limit=o),type:"number",min:"10",max:"3000",step:"100",class:"w-24 rounded-2xl border border-border bg-background px-3 py-2 text-xs text-foreground"},null,512),[[z,i.limit,void 0,{number:!0}]]),s("button",{class:"rounded-full border border-border px-4 py-2 text-xs font-medium text-foreground transition-colors hover:border-primary hover:text-primary",onClick:$}," 查询 "),s("button",{class:"rounded-full border border-border px-4 py-2 text-xs font-medium text-foreground transition-colors hover:border-primary hover:text-primary",onClick:re}," 导出 "),s("button",{class:"rounded-full border border-border px-4 py-2 text-xs font-medium text-foreground transition-colors hover:border-primary hover:text-primary",onClick:ae},r(f.value?"结构化视图":"原始视图"),1),s("button",{class:h(["rounded-full px-4 py-2 text-xs font-medium transition-colors",R.value?"bg-primary text-primary-foreground":"border border-border text-muted-foreground hover:text-foreground"]),onClick:ne}," 自动刷新 ",2),s("button",{class:"rounded-full border border-border px-4 py-2 text-xs font-medium text-destructive transition-colors hover:border-destructive/60",onClick:t[3]||(t[3]=o=>L.value=!0)}," 清空 ")]),v.value?(a(),n("div",{key:0,class:h(["mt-3 text-xs",Z.value])},r(v.value),3)):y("",!0),N.value?(a(),n("div",Ae,r(N.value),1)):y("",!0),f.value?(a(),n("div",{key:2,ref_key:"rawLogContainer",ref:b,class:"scrollbar-slim mt-4 max-h-[60vh] overflow-y-auto rounded-2xl border border-border bg-black px-4 py-3 text-xs text-green-200"},[s("pre",Te,r(te.value),1)],512)):(a(),n("div",{key:3,ref_key:"structuredLogContainer",ref:g,class:"scrollbar-slim mt-4 max-h-[60vh] space-y-3 overflow-y-auto rounded-2xl border border-border bg-card px-4 py-3"},[S.value.ungrouped.length===0&&S.value.groups.length===0?(a(),n("div",Ee," 暂无日志 ")):y("",!0),(a(!0),n(w,null,k(S.value.ungrouped,(o,l)=>(a(),n("div",{key:`u-${l}`},[s("div",Me,[s("div",Ue,[s("span",Fe,r(o.time),1),s("span",{class:h(D(o.level))},r(o.level),3),(a(!0),n(w,null,k(x(o.message).tags,d=>(a(),n("span",{key:d,class:"rounded px-2 py-0.5 text-[10px] font-semibold text-white",style:O({backgroundColor:V(d)})},r(d),5))),128)),x(o.message).accountId?(a(),n("span",{key:0,class:"text-[11px] font-semibold",style:O({color:T(x(o.message).accountId)})},r(x(o.message).accountId),5)):y("",!0)]),s("div",Ge,r(x(o.message).text),1)])]))),128)),(a(!0),n(w,null,k(S.value.groups,o=>(a(),n("div",{key:o.id,class:"rounded-2xl border border-border bg-card"},[s("button",{type:"button",class:"flex w-full flex-wrap items-center gap-2 rounded-2xl bg-secondary/40 px-4 py-3 text-left text-xs transition hover:bg-secondary/60",onClick:l=>se(o.id)},[s("span",{class:h(K(o.status))},r(Q(o.status)),3),s("span",De,"req_"+r(o.id),1),o.accountId?(a(),n("span",{key:0,class:"text-xs font-semibold",style:O({color:T(o.accountId)})},r(o.accountId),5)):y("",!0),o.model?(a(),n("span",He,r(o.model),1)):y("",!0),s("span",je,r(o.logs.length)+" 条日志",1),s("span",{class:h(["ml-auto text-muted-foreground transition-transform",{"rotate-90":!E(o.id)}])}," ▸ ",2)],8,Ve),U(s("div",qe,[(a(!0),n(w,null,k(o.logs,(l,d)=>(a(),n("div",{key:`${o.id}-${d}`,class:"flex flex-wrap items-center gap-2 rounded-xl border border-border bg-card px-3 py-2 text-xs"},[s("div",Be,[s("span",We,r(l.time),1),s("span",{class:h(D(l.level))},r(l.level),3),(a(!0),n(w,null,k(x(l.message).tags,c=>(a(),n("span",{key:c,class:"rounded px-2 py-0.5 text-[10px] font-semibold text-white",style:O({backgroundColor:V(c)})},r(c),5))),128)),x(l.message).accountId?(a(),n("span",{key:0,class:"text-[11px] font-semibold",style:O({color:T(x(l.message).accountId)})},r(x(l.message).accountId),5)):y("",!0)]),s("div",ze,r(x(l.message).text),1)]))),128))],512),[[me,!E(o.id)]])]))),128))],512))]),W(pe,{open:L.value,title:"确认操作",message:"确定要清空所有运行日志吗？","confirm-text":"确认","cancel-text":"取消",onConfirm:le,onCancel:t[4]||(t[4]=o=>L.value=!1)},null,8,["open"])],64))}});export{Ze as default};
